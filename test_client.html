<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Article Generator Test (Improved)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #messages div { margin-bottom: 8px; padding: 8px; border-radius: 4px; word-wrap: break-word; }
        .server-msg { background-color: #e0f2fe; border-left: 4px solid #3b82f6; }
        .client-msg { background-color: #dcfce7; text-align: right; border-right: 4px solid #16a34a; }
        .error-msg { background-color: #fee2e2; border-left: 4px solid #ef4444; color: #b91c1c; }
        .info-msg { background-color: #f3f4f6; border-left: 4px solid #6b7280; color: #4b5563; font-style: italic; font-size: 0.9em;}
        .user-input-req { background-color: #fef9c3; border-left: 4px solid #f59e0b; }
        #final-article-preview { border: 1px solid #ccc; padding: 15px; margin-top: 15px; max-height: 500px; overflow-y: auto; background-color: #f9f9f9; }
        pre { white-space: pre-wrap; word-wrap: break-word; background-color: #f4f4f5; padding: 10px; border-radius: 5px; margin-top: 5px; font-family: monospace; font-size: 0.9em; max-height: 300px; overflow-y: auto;}
        code { font-family: monospace; }
        label { font-weight: 500; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .tab-button { padding: 8px 16px; cursor: pointer; border: 1px solid #ccc; border-bottom: none; background-color: #f0f0f0; border-radius: 4px 4px 0 0; margin-right: 2px;}
        .tab-button.active { background-color: white; border-bottom: 1px solid white; position: relative; top: 1px;}
        .tab-content { border: 1px solid #ccc; padding: 15px; border-radius: 0 4px 4px 4px; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 font-sans">
    <div class="container mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-6 text-center">WebSocket Article Generator Test</h1>

        <div class="mb-6 p-4 border rounded-md bg-gray-50">
            <h2 class="text-lg font-semibold mb-3">1. Connection</h2>
            <div class="mb-3">
                <label for="ws_url" class="block text-sm font-medium text-gray-700">WebSocket URL:</label>
                <input type="text" id="ws_url" value="ws://localhost:8000/articles/ws/generate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
            <div>
                <button id="connectBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2">Connect</button>
                <button id="disconnectBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded" disabled>Disconnect</button>
                <span id="connectionStatus" class="ml-4 text-sm font-medium text-gray-500">Disconnected</span>
            </div>
        </div>

        <div class="mb-6 p-4 border rounded-md bg-gray-50">
            <h2 class="text-lg font-semibold mb-3">2. Initial Request</h2>
            <div class="mb-1 border-b border-gray-200">
                <nav class="-mb-px flex" aria-label="Tabs">
                    <button id="tab-form" class="tab-button active" onclick="switchTab('form')">Form Input</button>
                    <button id="tab-json" class="tab-button" onclick="switchTab('json')">Raw JSON</button>
                </nav>
            </div>

            <div id="content-form" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="initial_keywords" class="block text-sm font-medium text-gray-700">Keywords (comma-separated):</label>
                        <input type="text" id="initial_keywords" value="札幌, 注文住宅, 自然素材, 子育て" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="target_persona" class="block text-sm font-medium text-gray-700">Target Persona:</label>
                        <input type="text" id="target_persona" value="札幌近郊で自然素材を使った家づくりに関心がある、小さな子供を持つ30代夫婦" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="target_length" class="block text-sm font-medium text-gray-700">Target Length (optional):</label>
                        <input type="number" id="target_length" value="3000" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="num_theme_proposals" class="block text-sm font-medium text-gray-700">Num Theme Proposals:</label>
                        <input type="number" id="num_theme_proposals" value="3" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                     <div>
                        <label for="num_research_queries" class="block text-sm font-medium text-gray-700">Num Research Queries:</label>
                        <input type="number" id="num_research_queries" value="5" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
                 <div class="mb-4">
                    <label for="company_name" class="block text-sm font-medium text-gray-700">Company Name (optional):</label>
                    <input type="text" id="company_name" value="株式会社ナチュラルホームズ札幌" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                 <div class="mb-4">
                    <label for="company_description" class="block text-sm font-medium text-gray-700">Company Description (optional):</label>
                    <textarea id="company_description" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">札幌を拠点に、自然素材を活かした健康で快適な注文住宅を提供しています。</textarea>
                </div>
                 <div class="mb-4">
                    <label for="company_style_guide" class="block text-sm font-medium text-gray-700">Company Style Guide (optional):</label>
                    <textarea id="company_style_guide" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">専門用語を避け、温かみのある丁寧語（ですます調）で。子育て世代の読者に寄り添い、安心感を与えるようなトーンを心がける。</textarea>
                </div>
                <button id="sendFormRequestBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" disabled>Send Request from Form</button>
            </div>

            <div id="content-json" class="tab-content hidden">
                <label for="initial_request_json" class="block text-sm font-medium text-gray-700">Raw Initial Request (JSON):</label>
                <textarea id="initial_request_json" rows="10" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm font-mono">{
  "initial_keywords": ["札幌", "注文住宅", "自然素材", "子育て"],
  "target_persona": "札幌近郊で自然素材を使った家づくりに関心がある、小さな子供を持つ30代夫婦",
  "target_length": 3000,
  "num_theme_proposals": 3,
  "num_research_queries": 5,
  "company_name": "株式会社ナチュラルホームズ札幌",
  "company_description": "札幌を拠点に、自然素材を活かした健康で快適な注文住宅を提供しています。",
  "company_style_guide": "専門用語を避け、温かみのある丁寧語（ですます調）で。子育て世代の読者に寄り添い、安心感を与えるようなトーンを心がける。"
}</textarea>
                <button id="sendJsonRequestBtn" class="mt-2 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" disabled>Send Raw JSON Request</button>
            </div>
        </div>

        <div class="mb-6 p-4 border rounded-md bg-gray-50">
             <h2 class="text-lg font-semibold mb-3">3. Process Log & Interaction</h2>
            <div id="messages" class="h-96 overflow-y-auto border border-gray-300 p-4 rounded-md bg-white mb-4 shadow-inner">
                </div>

            <div id="user-interaction" class="hidden mt-4 p-4 border-2 border-yellow-400 bg-yellow-50 rounded-md shadow">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    User Input Required
                </h3>
                <div id="user-prompt" class="text-yellow-700 mb-3"></div>
                <div id="interaction-options" class="space-y-3">
                    </div>
            </div>
        </div>

         <div id="final-article-container" class="hidden mt-6 p-4 border rounded-md bg-gray-50">
            <h2 class="text-lg font-semibold mb-3">4. Final Article</h2>
            <button id="copyHtmlBtn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded mb-3">Copy HTML to Clipboard</button>
             <div id="final-article-preview" class="prose max-w-none">
                 </div>
         </div>

    </div>

    <script>
        const wsUrlInput = document.getElementById('ws_url');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const connectionStatusSpan = document.getElementById('connectionStatus');

        const initialKeywordsInput = document.getElementById('initial_keywords');
        const targetPersonaInput = document.getElementById('target_persona');
        const targetLengthInput = document.getElementById('target_length');
        const numThemeProposalsInput = document.getElementById('num_theme_proposals');
        const numResearchQueriesInput = document.getElementById('num_research_queries');
        const companyNameInput = document.getElementById('company_name');
        const companyDescriptionInput = document.getElementById('company_description');
        const companyStyleGuideInput = document.getElementById('company_style_guide');
        const sendFormRequestBtn = document.getElementById('sendFormRequestBtn');

        const initialRequestJsonText = document.getElementById('initial_request_json');
        const sendJsonRequestBtn = document.getElementById('sendJsonRequestBtn');

        const messagesDiv = document.getElementById('messages');
        const userInteractionDiv = document.getElementById('user-interaction');
        const userPromptDiv = document.getElementById('user-prompt'); // Changed to Div for innerHTML
        const interactionOptionsDiv = document.getElementById('interaction-options');
        const finalArticleContainer = document.getElementById('final-article-container');
        const finalArticlePreviewDiv = document.getElementById('final-article-preview');
        const copyHtmlBtn = document.getElementById('copyHtmlBtn');

        const tabForm = document.getElementById('tab-form');
        const tabJson = document.getElementById('tab-json');
        const contentForm = document.getElementById('content-form');
        const contentJson = document.getElementById('content-json');

        let websocket = null;
        let currentRequestType = null;
        let finalHtmlContent = '';
        let messageCounter = 0; // メッセージ識別用

        // --- Tab Switching ---
        function switchTab(tabName) {
            if (tabName === 'form') {
                tabForm.classList.add('active');
                tabJson.classList.remove('active');
                contentForm.classList.remove('hidden');
                contentJson.classList.add('hidden');
            } else {
                tabForm.classList.remove('active');
                tabJson.classList.add('active');
                contentForm.classList.add('hidden');
                contentJson.classList.remove('hidden');
            }
        }

        // --- Logging ---
        function logMessage(message, type = 'info') {
            const div = document.createElement('div');
            messageCounter++;
            div.id = `msg-${messageCounter}`;

            let typeClass = 'info-msg';
            let prefix = '[INFO]';
            if (type === 'server') { typeClass = 'server-msg'; prefix = '[SERVER]'; }
            else if (type === 'client') { typeClass = 'client-msg'; prefix = '[CLIENT]'; }
            else if (type === 'error') { typeClass = 'error-msg'; prefix = '[ERROR]'; }
            else if (type === 'user-input') { typeClass = 'user-input-req'; prefix = '[INPUT REQ]'; }

            div.className = typeClass;

             // メッセージがJSON文字列かどうかを判定
            let displayMessage = message;
            try {
                const parsed = JSON.parse(message);
                // JSONなら整形して表示
                 displayMessage = `<pre><code>${JSON.stringify(parsed, null, 2)}</code></pre>`;
                 div.innerHTML = `<strong>${prefix}</strong> ${displayMessage}`;
            } catch (e) {
                 // JSONでなければそのまま表示
                 div.innerHTML = `<strong>${prefix}</strong> ${message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}`; // Basic HTML escaping
            }


            messagesDiv.appendChild(div);
            // 少し遅延させてからスクロールを実行すると確実
            setTimeout(() => {
                 messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 50);
        }

        // --- UI Updates ---
        function updateConnectionStatus(status, color = 'text-gray-500') {
            connectionStatusSpan.textContent = status;
            connectionStatusSpan.className = `ml-4 text-sm font-medium ${color}`;
        }

        function enableButtonsOnConnect(connected) {
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            sendFormRequestBtn.disabled = !connected;
            sendJsonRequestBtn.disabled = !connected;
        }

        // --- WebSocket Logic ---
        connectBtn.onclick = () => {
            // ... (接続ロジックは変更なし) ...
            const url = wsUrlInput.value;
            if (!url) {
                logMessage('Please enter a WebSocket URL.', 'error');
                return;
            }
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                logMessage('Already connected.');
                return;
            }

            logMessage(`Connecting to ${url}...`);
            updateConnectionStatus('Connecting...', 'text-yellow-500');
            websocket = new WebSocket(url);

            websocket.onopen = (event) => {
                logMessage('WebSocket Connected!');
                updateConnectionStatus('Connected', 'text-green-600');
                enableButtonsOnConnect(true);
                 // 接続時にフォーム/JSON入力を無効化し、切断/完了時に再度有効化する（任意）
                // disableInitialInput(true);
            };

            websocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    logMessage(JSON.stringify(data), 'server'); // Log raw JSON

                    if (data.type === 'server_event') {
                        const payload = data.payload;
                        const eventType = payload.event_type;

                        if (eventType === 'status_update') {
                            logMessage(`Status: ${payload.step} - ${payload.message}`, 'info');
                        } else if (eventType === 'section_generated') {
                            // ここでHTMLチャンクをリアルタイム表示することも可能
                            console.log(`Received chunk for section ${payload.section_index}`);
                            if (payload.is_complete) {
                                logMessage(`Section ${payload.section_index + 1} (${payload.heading}) generation complete.`, 'info');
                            }
                        } else if (eventType === 'final_result') {
                            logMessage('Article generation complete!', 'info');
                            displayFinalArticle(payload.title, payload.final_html_content);
                             // disableInitialInput(false); // 再度有効化
                        } else if (eventType === 'error') {
                            logMessage(`ERROR (${payload.step}): ${payload.error_message}`, 'error');
                            disconnectBtn.click(); // エラー時は切断
                             // disableInitialInput(false); // 再度有効化
                        } else if (eventType === 'user_input_request') {
                            logMessage(`Server requests input: ${payload.request_type}`, 'user-input');
                            displayInteraction(payload.request_type, payload.data);
                        } else {
                             // 他のイベント（情報提供のみ）はメッセージログに詳細表示
                             logMessage(`Event '${eventType}': ${JSON.stringify(payload, null, 2)}`, 'info');
                        }
                    } else {
                         logMessage(`Received unknown message type: ${data.type}`, 'info');
                    }
                } catch (e) {
                    logMessage(`Error parsing message: ${e}`, 'error');
                    logMessage(`Raw data: ${event.data}`, 'info');
                }
            };

            websocket.onerror = (event) => {
                logMessage('WebSocket Error. Check console.', 'error');
                console.error("WebSocket Error: ", event);
                updateConnectionStatus('Error', 'text-red-600');
                enableButtonsOnConnect(false);
                 // disableInitialInput(false);
            };

            websocket.onclose = (event) => {
                logMessage(`WebSocket Closed: Code=${event.code}, Reason=${event.reason || 'N/A'}`, 'info');
                websocket = null;
                updateConnectionStatus('Disconnected', 'text-gray-500');
                enableButtonsOnConnect(false);
                hideInteraction();
                 // disableInitialInput(false);
            };
        };

        disconnectBtn.onclick = () => {
            // ... (切断ロジックは変更なし) ...
             if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.close();
                logMessage('Disconnecting...');
            } else {
                logMessage('Not connected.');
            }
        };

        // --- Initial Request Sending ---
        function sendInitialRequest(requestData) {
             if (websocket && websocket.readyState === WebSocket.OPEN) {
                try {
                    const messageStr = JSON.stringify(requestData);
                    websocket.send(messageStr);
                    logMessage(`SENT Initial Request: ${messageStr}`, 'client');
                    sendFormRequestBtn.disabled = true; // 送信ボタンを無効化
                    sendJsonRequestBtn.disabled = true;
                    // disableInitialInput(true); // 入力フォームも無効化
                } catch (e) {
                    logMessage(`Failed to send initial request: ${e}`, 'error');
                }
            } else {
                logMessage('WebSocket is not connected.', 'error');
            }
        }

        sendFormRequestBtn.onclick = () => {
            const keywords = initialKeywordsInput.value.split(',').map(k => k.trim()).filter(k => k);
            const targetLength = targetLengthInput.value ? parseInt(targetLengthInput.value, 10) : null;
            const requestData = {
                initial_keywords: keywords,
                target_persona: targetPersonaInput.value || null,
                target_length: isNaN(targetLength) ? null : targetLength,
                num_theme_proposals: parseInt(numThemeProposalsInput.value, 10) || 3,
                num_research_queries: parseInt(numResearchQueriesInput.value, 10) || 5,
                company_name: companyNameInput.value || null,
                company_description: companyDescriptionInput.value || null,
                company_style_guide: companyStyleGuideInput.value || null,
            };
            sendInitialRequest(requestData);
        };

        sendJsonRequestBtn.onclick = () => {
             try {
                const requestData = JSON.parse(initialRequestJsonText.value);
                sendInitialRequest(requestData);
            } catch (e) {
                logMessage(`Invalid JSON in Raw Request: ${e}`, 'error');
            }
        };

        // --- User Interaction Handling ---
        function displayInteraction(requestType, data) {
            currentRequestType = requestType;
            userInteractionDiv.classList.remove('hidden');
            interactionOptionsDiv.innerHTML = ''; // Clear previous options
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to show interaction panel

            if (requestType === 'select_theme') {
                userPromptDiv.innerHTML = '<strong>Please select a theme:</strong>';
                if (data && data.themes && Array.isArray(data.themes)) {
                    data.themes.forEach((theme, index) => {
                        const button = document.createElement('button');
                        button.innerHTML = `
                            <strong class="text-blue-700">${index + 1}. ${theme.title}</strong>
                            <p class="text-xs text-gray-600 mt-1">Desc: ${theme.description}</p>
                            <p class="text-xs text-gray-500 mt-1">Keywords: ${theme.keywords.join(', ')}</p>
                        `;
                        button.className = 'block w-full text-left bg-white hover:bg-gray-100 text-gray-800 py-2 px-4 border border-gray-300 rounded shadow mb-2 transition duration-150 ease-in-out';
                        button.onclick = () => sendClientResponse(requestType, { selected_index: index });
                        interactionOptionsDiv.appendChild(button);
                    });
                } else {
                     userPromptDiv.innerHTML += '<p class="text-red-600">No themes received.</p>';
                }
            } else if (requestType === 'approve_plan' || requestType === 'approve_outline') {
                 const planOrOutline = data.plan || data.outline;
                 const typeName = requestType === 'approve_plan' ? 'research plan' : 'outline';
                 userPromptDiv.innerHTML = `<strong>Please review the following ${typeName} and approve/reject:</strong> <pre><code>${JSON.stringify(planOrOutline, null, 2)}</code></pre>`;

                 const buttonContainer = document.createElement('div');
                 buttonContainer.className = 'flex justify-end space-x-3 mt-3';

                 const approveBtn = document.createElement('button');
                 approveBtn.textContent = 'Approve';
                 approveBtn.className = 'bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out';
                 approveBtn.onclick = () => sendClientResponse(requestType, { approved: true });
                 buttonContainer.appendChild(approveBtn);

                 const rejectBtn = document.createElement('button');
                 rejectBtn.textContent = 'Reject';
                 rejectBtn.className = 'bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out';
                 rejectBtn.onclick = () => sendClientResponse(requestType, { approved: false });
                 buttonContainer.appendChild(rejectBtn);

                 interactionOptionsDiv.appendChild(buttonContainer);
            } else {
                 userPromptDiv.textContent = `Unknown input request type: ${requestType}`;
            }
        }

        function hideInteraction() {
            userInteractionDiv.classList.add('hidden');
            userPromptDiv.innerHTML = '';
            interactionOptionsDiv.innerHTML = '';
            currentRequestType = null;
        }

        function displayFinalArticle(title, htmlContent) {
            finalHtmlContent = htmlContent; // 保存用に保持
            finalArticleContainer.classList.remove('hidden');
            // Sanitize HTML before inserting (basic example, consider a library for production)
            const sanitizedHtml = htmlContent.replace(/<script.*?>.*?<\/script>/gi, ''); // Remove script tags
            finalArticlePreviewDiv.innerHTML = `<h3 class="text-xl font-semibold mb-3">${title}</h3>${sanitizedHtml}`;
        }

        function sendClientResponse(responseType, payload) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const message = {
                    type: "client_response",
                    response_type: responseType,
                    payload: payload
                };
                const messageStr = JSON.stringify(message);
                websocket.send(messageStr);
                logMessage(messageStr, 'client');
                hideInteraction(); // Hide interaction panel after sending response
            } else {
                logMessage('WebSocket is not connected.', 'error');
            }
        }

        copyHtmlBtn.onclick = () => {
            // ... (コピーロジックは変更なし) ...
             if (finalHtmlContent) {
                navigator.clipboard.writeText(finalHtmlContent)
                    .then(() => {
                        logMessage('Final HTML copied to clipboard!', 'info');
                    })
                    .catch(err => {
                        logMessage('Failed to copy HTML.', 'error');
                        console.error('Clipboard copy failed: ', err);
                    });
            }
        };

        // Initialize with form tab active
        switchTab('form');

    </script>
</body>
</html>
